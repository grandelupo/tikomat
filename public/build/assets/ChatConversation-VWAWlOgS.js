import{r as a,v as A,j as e,$ as K,Y as V,m as v}from"./app-BKDgtsOL.js";import{c as E,B as o}from"./button-Cs23Ldw7.js";import{C as W,a as G,b as Q,c as Z}from"./card-D-J_O7wT.js";import{I as ee}from"./input-C8bdQ77l.js";import{B as se}from"./badge-HDYOpFie.js";import{T as te}from"./textarea-BJIVfncV.js";import{A as ae,X as re}from"./app-layout-CSQgW9_r.js";import{A as ie}from"./arrow-left-6ERnWau-.js";import{U as R}from"./user-BeqRMz80.js";import{C as ne}from"./calendar-CGQVCRqe.js";import{M as le}from"./message-circle-BidF00S6.js";import{H as ce}from"./headphones-CkYZ8Tkk.js";import{L as T}from"./loader-circle-CBQrpjB3.js";import{S as oe}from"./send-BxvgdwgG.js";import{C as D}from"./circle-alert-gUJT0zup.js";import{C as de}from"./circle-check-big-CEpWA4_Y.js";import{C as me}from"./clock-D8Uvsh4d.js";import"./index-F2H_rb8F.js";import"./index-BWgdCkjI.js";import"./workflow-R8ZM5xfN.js";import"./video-DX3fiLTt.js";/**
 * @license lucide-react v0.475.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const xe=[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}]],he=E("RotateCcw",xe);/**
 * @license lucide-react v0.475.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ue=[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["polyline",{points:"16 11 18 13 22 9",key:"1pwet4"}]],ge=E("UserCheck",ue);function Be({conversation:t,messages:L,admin:p}){const[d,m]=a.useState(L),[U,j]=a.useState(!1),[C,_]=a.useState(0),[S,u]=a.useState("connecting"),k=a.useRef(null),w=a.useRef(null),b=a.useRef(null),{data:g,setData:B,processing:y,reset:q,errors:$}=A({message:""}),{data:F,setData:H,post:O,processing:I}=A({reason:""}),z=()=>{var s;(s=k.current)==null||s.scrollIntoView({behavior:"smooth"})};a.useEffect(()=>{z()},[d]),a.useEffect(()=>{var s;(s=w.current)==null||s.focus()},[]),a.useEffect(()=>{d.length>0&&_(Math.max(...d.map(r=>r.id))),u("connected");const s=async()=>{try{const r=await fetch(`${route("admin.chat.poll",t.id)}?last_message_id=${C}`,{headers:{Accept:"application/json"}});if(r.ok){const i=await r.json();if(i.messages&&i.messages.length>0){const x=i.messages.filter(n=>!n.is_from_admin);x.length>0&&m(n=>[...n,...x]),_(Math.max(...i.messages.map(n=>n.id)))}u("connected")}else u("disconnected")}catch(r){console.error("Admin polling error:",r),u("disconnected")}};return b.current=setInterval(s,2e3),()=>{b.current&&clearInterval(b.current)}},[t.id,C]);const P=async s=>{var x,n;if(s.preventDefault(),!g.message.trim())return;const r=g.message,i={id:Date.now(),conversation_id:t.id,user_id:p.id,message:r,is_from_admin:!0,sender_name:p.name,formatted_time:new Date().toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"}),created_at:new Date().toISOString(),user:p};m(c=>[...c,i]),q("message"),(x=w.current)==null||x.focus();try{const c=await fetch(route("admin.chat.send",t.id),{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((n=document.querySelector('meta[name="csrf-token"]'))==null?void 0:n.getAttribute("content"))||""},body:JSON.stringify({message:r})});if(!c.ok)throw new Error("Failed to send message");const l=await c.json();l.success?m(h=>h.map(f=>f.id===i.id?{...l.message,sender_name:l.message.user.name,formatted_time:new Date(l.message.created_at).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"})}:f)):(m(h=>h.filter(f=>f.id!==i.id)),console.error("Failed to send message:",l.error))}catch(c){m(l=>l.filter(h=>h.id!==i.id)),console.error("Error sending message:",c)}},X=()=>{O(route("admin.chat.close",t.id),{onSuccess:()=>{j(!1),v.visit(route("admin.chat.index"))}})},M=()=>{v.post(route("admin.chat.reopen",t.id),{},{onSuccess:()=>{v.reload()}})},N=(()=>{switch(t.status){case"waiting":return{status:"Waiting for assignment",color:"bg-yellow-100 text-yellow-800",icon:me};case"active":return{status:"Active conversation",color:"bg-green-100 text-green-800",icon:de};case"closed":return{status:"Conversation closed",color:"bg-gray-100 text-gray-800",icon:D};default:return{status:"Unknown status",color:"bg-gray-100 text-gray-800",icon:D}}})(),Y=N.icon,J=[{title:"Admin",href:"/admin"},{title:"Chat Management",href:"/admin/chat"},{title:`Chat with ${t.user.name}`,href:`/admin/chat/${t.id}`}];return e.jsxs(ae,{breadcrumbs:J,children:[e.jsx(K,{title:`Chat with ${t.user.name} - Admin`}),e.jsx("div",{className:"py-6",children:e.jsxs("div",{className:"max-w-4xl mx-auto sm:px-6 lg:px-8",children:[e.jsx("div",{className:"mb-6",children:e.jsx(V,{href:route("admin.chat.index"),children:e.jsxs(o,{variant:"outline",children:[e.jsx(ie,{className:"w-4 h-4 mr-2"}),"Back to Chat Management"]})})}),e.jsxs("div",{className:"bg-white overflow-hidden shadow-sm sm:rounded-lg",children:[e.jsx("div",{className:"bg-gradient-to-r from-blue-600 to-purple-600 px-6 py-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("div",{className:"w-12 h-12 bg-white/20 rounded-full flex items-center justify-center",children:e.jsx(R,{className:"w-6 h-6 text-white"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-xl font-semibold text-white",children:t.user.name}),e.jsx("p",{className:"text-blue-100 text-sm",children:t.user.email})]})]}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsxs(se,{className:`${N.color} border-0`,children:[e.jsx(Y,{className:"w-3 h-3 mr-1"}),N.status]}),e.jsx("div",{className:`w-2 h-2 rounded-full ${S==="connected"?"bg-green-400":S==="connecting"?"bg-yellow-400":"bg-red-400"}`}),e.jsx("div",{className:"flex items-center space-x-2",children:t.status==="closed"?e.jsxs(o,{onClick:M,size:"sm",className:"bg-white/20 hover:bg-white/30 text-white border-white/30",children:[e.jsx(he,{className:"w-4 h-4 mr-1"}),"Reopen"]}):e.jsxs(o,{onClick:()=>j(!0),size:"sm",className:"bg-white/20 hover:bg-white/30 text-white border-white/30",children:[e.jsx(re,{className:"w-4 h-4 mr-1"}),"Close"]})})]})]})}),e.jsx("div",{className:"border-b bg-gray-50 px-6 py-3",children:e.jsxs("div",{className:"flex items-center justify-between text-sm text-gray-600",children:[e.jsxs("div",{className:"flex items-center space-x-6",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(ne,{className:"w-4 h-4 mr-1"}),"Started: ",new Date(t.created_at).toLocaleString()]}),t.assigned_admin&&e.jsxs("div",{className:"flex items-center",children:[e.jsx(ge,{className:"w-4 h-4 mr-1"}),"Assigned to: ",t.assigned_admin.name]})]}),e.jsxs("div",{className:"text-sm text-gray-500",children:["Conversation #",t.id]})]})}),e.jsxs("div",{className:"h-96 overflow-y-auto p-4 space-y-4 bg-gray-50",children:[d.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(le,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"No messages yet"}),e.jsx("p",{className:"text-gray-600",children:"This conversation hasn't started yet."})]}):d.map(s=>e.jsx("div",{className:`flex ${s.is_from_admin?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${s.is_from_admin?"bg-blue-600 text-white":"bg-white text-gray-900 shadow-sm border"}`,children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-1",children:[e.jsx("div",{className:`w-6 h-6 rounded-full flex items-center justify-center ${s.is_from_admin?"bg-blue-500":"bg-gray-100"}`,children:s.is_from_admin?e.jsx(ce,{className:`w-3 h-3 ${s.is_from_admin?"text-white":"text-gray-600"}`}):e.jsx(R,{className:`w-3 h-3 ${s.is_from_admin?"text-white":"text-gray-600"}`})}),e.jsx("span",{className:`text-xs font-medium ${s.is_from_admin?"text-blue-100":"text-gray-600"}`,children:s.sender_name}),e.jsx("span",{className:`text-xs ${s.is_from_admin?"text-blue-200":"text-gray-500"}`,children:s.formatted_time})]}),e.jsx("p",{className:"text-sm leading-relaxed",children:s.message})]})},s.id)),e.jsx("div",{ref:k})]}),e.jsxs("div",{className:"border-t bg-white p-4",children:[t.status==="closed"?e.jsxs("div",{className:"text-center py-4 text-gray-500",children:["This conversation has been closed.",e.jsx("button",{onClick:M,className:"text-blue-600 hover:text-blue-700 ml-1 underline",children:"Reopen conversation"})," to continue messaging."]}):e.jsxs("form",{onSubmit:P,className:"flex space-x-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx(ee,{ref:w,type:"text",value:g.message,onChange:s=>B("message",s.target.value),placeholder:"Type your response...",disabled:y,className:"w-full"}),$.message&&e.jsx("p",{className:"text-red-600 text-sm mt-1",children:$.message})]}),e.jsx(o,{type:"submit",disabled:y||!g.message.trim(),className:"bg-blue-600 hover:bg-blue-700",children:y?e.jsx(T,{className:"w-4 h-4 animate-spin"}):e.jsx(oe,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"flex items-center justify-between mt-3 text-xs text-gray-500",children:[e.jsx("span",{children:"Press Enter to send"}),e.jsxs("span",{children:[t.status==="waiting"&&"Conversation will be activated when you send a message",t.status==="active"&&"Connected with user",t.status==="closed"&&"Conversation is closed"]})]})]})]})]})}),U&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:e.jsxs(W,{className:"w-full max-w-md",children:[e.jsx(G,{children:e.jsx(Q,{children:"Close Conversation"})}),e.jsxs(Z,{className:"space-y-4",children:[e.jsxs("p",{className:"text-gray-600",children:["Are you sure you want to close this conversation with ",t.user.name,"?"]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Reason for closing (optional)"}),e.jsx(te,{value:F.reason,onChange:s=>H("reason",s.target.value),placeholder:"e.g., Issue resolved, User request, etc.",className:"w-full"})]}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsx(o,{onClick:()=>j(!1),variant:"outline",className:"flex-1",children:"Cancel"}),e.jsxs(o,{onClick:X,disabled:I,className:"flex-1 bg-red-600 hover:bg-red-700",children:[I?e.jsx(T,{className:"w-4 h-4 animate-spin mr-2"}):null,"Close Conversation"]})]})]})]})})]})}export{Be as default};
